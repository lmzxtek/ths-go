<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËÇ°Á•®Ë°åÊÉÖÂÆûÊó∂Êü•Áúã</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/klinecharts/dist/klinecharts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #434448 0%, #79757e 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .symbol-select {
            padding: 10px 15px;
            border: 2px solid #667eea;
            border-radius: 25px;
            background: white;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .symbol-select:focus {
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.1);
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
        }
        
        .status.connected {
            background: rgba(34, 197, 94, 0.1);
            color: #16a34a;
        }
        
        .status.disconnected {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status.connected .status-dot {
            background: #16a34a;
        }
        
        .status.disconnected .status-dot {
            background: #dc2626;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .chart-container {
            background: rgba(160, 158, 158, 0.352);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .chart-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
        }
        
        .last-update {
            color: #666;
            font-size: 0.9em;
        }
        
        #chart {
            width: 100%;
            height: 500px;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
        }
        
        .stat-value.positive {
            color: #16a34a;
        }
        
        .stat-value.negative {
            color: #dc2626;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <h1>üìà ËÇ°Á•®Ë°åÊÉÖÂÆûÊó∂ÁõëÊéß</h1>
                <div class="controls">
                    <select v-model="selectedSymbol" @change="changeSymbol" class="symbol-select">
                        <option value="AAPL">ËãπÊûú (AAPL)</option>
                        <option value="GOOGL">Ë∞∑Ê≠å (GOOGL)</option>
                        <option value="MSFT">ÂæÆËΩØ (MSFT)</option>
                        <option value="TSLA">ÁâπÊñØÊãâ (TSLA)</option>
                        <option value="AMZN">‰∫öÈ©¨ÈÄä (AMZN)</option>
                    </select>
                    <div :class="['status', isConnected ? 'connected' : 'disconnected']">
                        <div class="status-dot"></div>
                        {{ isConnected ? 'Â∑≤ËøûÊé•' : 'Êú™ËøûÊé•' }}
                    </div>
                </div>
            </div>
            
            <div v-if="error" class="error">
                {{ error }}
            </div>
            
            <div v-if="currentStock" class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">ÂΩìÂâç‰ª∑Ê†º</div>
                    <div class="stat-value">${{ currentStock.close.toFixed(2) }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Ê∂®Ë∑åÂπÖ</div>
                    <div :class="['stat-value', priceChange >= 0 ? 'positive' : 'negative']">
                        {{ priceChange >= 0 ? '+' : '' }}{{ priceChange.toFixed(2) }}%
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ÊúÄÈ´ò‰ª∑</div>
                    <div class="stat-value">${{ currentStock.high.toFixed(2) }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ÊúÄ‰Ωé‰ª∑</div>
                    <div class="stat-value">${{ currentStock.low.toFixed(2) }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Êàê‰∫§Èáè</div>
                    <div class="stat-value">{{ formatVolume(currentStock.volume) }}</div>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">{{ selectedSymbol }} KÁ∫øÂõæ</div>
                    <div class="last-update">ÊúÄÂêéÊõ¥Êñ∞: {{ lastUpdate }}</div>
                </div>
                <div v-if="loading" class="loading">
                    <div class="spinner"></div>
                    <div>Âä†ËΩΩ‰∏≠...</div>
                </div>
                <div id="chart"></div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted, onUnmounted, computed, watch } = Vue;
        
        createApp({
            setup() {
                const selectedSymbol = ref('AAPL');
                const chartData = ref([]);
                const currentStock = ref(null);
                const loading = ref(true);
                const error = ref('');
                const isConnected = ref(false);
                const lastUpdate = ref('');
                let chart = null;
                let updateInterval = null;
                
                const priceChange = computed(() => {
                    if (!currentStock.value || chartData.value.length < 2) return 0;
                    const current = currentStock.value.close;
                    const previous = chartData.value[chartData.value.length - 2]?.close || current;
                    return ((current - previous) / previous) * 100;
                });
                
                // ÂàùÂßãÂåñÂõæË°®
                const initChart = () => {
                    const chartElement = document.getElementById('chart');
                    if (chartElement && !chart) {
                        chart = klinecharts.init(chartElement);
                        
                        // ËÆæÁΩÆÂõæË°®Ê†∑Âºè
                        chart.setStyleOptions({
                            grid: {
                                show: true,
                                horizontal: {
                                    show: true,
                                    color: '#E9EEF3',
                                    style: 'dashed'
                                },
                                vertical: {
                                    show: true,
                                    color: '#E9EEF3',
                                    style: 'dashed'
                                }
                            },
                            candle: {
                                priceMark: {
                                    show: true,
                                    high: {
                                        color: '#16a34a'
                                    },
                                    low: {
                                        color: '#dc2626'
                                    }
                                },
                                tooltip: {
                                    showRule: 'always',
                                    labels: ['ÂºÄÁõò', 'Êî∂Áõò', 'ÊúÄÈ´ò', 'ÊúÄ‰Ωé', 'Êàê‰∫§Èáè']
                                }
                            },
                            xAxis: {
                                show: true,
                                tickText: {
                                    color: '#666'
                                }
                            },
                            yAxis: {
                                show: true,
                                tickText: {
                                    color: '#666'
                                }
                            }
                        });
                    }
                };
                
                // ÁîüÊàêÊ®°ÊãüÊï∞ÊçÆ
                const generateMockData = (symbol, count = 100) => {
                    const data = [];
                    let basePrice = 150;
                    
                    // Ê†πÊçÆËÇ°Á•®Á¨¶Âè∑ËÆæÁΩÆ‰∏çÂêåÁöÑÂü∫Á°Ä‰ª∑Ê†º
                    switch (symbol) {
                        case 'AAPL': basePrice = 150; break;
                        case 'GOOGL': basePrice = 2800; break;
                        case 'MSFT': basePrice = 330; break;
                        case 'TSLA': basePrice = 200; break;
                        case 'AMZN': basePrice = 3200; break;
                    }
                    
                    const now = new Date();
                    
                    for (let i = count; i >= 0; i--) {
                        const timestamp = new Date(now.getTime() - i * 60000); // ÊØèÂàÜÈíü‰∏Ä‰∏™Êï∞ÊçÆÁÇπ
                        
                        // ÁîüÊàêÈöèÊú∫‰ª∑Ê†ºÂèòÂä®
                        const change = (Math.random() - 0.5) * basePrice * 0.02;
                        basePrice = Math.max(basePrice + change, basePrice * 0.9);
                        
                        const open = basePrice;
                        const high = open + Math.random() * open * 0.01;
                        const low = open - Math.random() * open * 0.01;
                        const close = low + Math.random() * (high - low);
                        const volume = Math.floor(Math.random() * 1000000) + 100000;
                        
                        data.push({
                            timestamp: timestamp.getTime(),
                            open: parseFloat(open.toFixed(2)),
                            high: parseFloat(high.toFixed(2)),
                            low: parseFloat(low.toFixed(2)),
                            close: parseFloat(close.toFixed(2)),
                            volume: volume
                        });
                        
                        basePrice = close;
                    }
                    
                    return data;
                };
                
                // WebSocketÁõ∏ÂÖ≥
                let ws = null;
                const API_BASE = 'http://localhost:5004/api/v1';
                const WS_BASE = 'ws://localhost:5004/ws';
                
                // Ëé∑ÂèñËÇ°Á•®Êï∞ÊçÆ
                const fetchStockData = async () => {
                    try {
                        loading.value = true;
                        error.value = '';
                        
                        // ‰ªéÂêéÁ´ØAPIËé∑ÂèñÂéÜÂè≤Êï∞ÊçÆ
                        const response = await fetch(`${API_BASE}/stocks/${selectedSymbol.value}?limit=100`);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const result = await response.json();
                        chartData.value = result.data;
                        currentStock.value = result.data[result.data.length - 1];
                        isConnected.value = true;
                        lastUpdate.value = new Date().toLocaleString('zh-CN');
                        
                        // Êõ¥Êñ∞ÂõæË°®
                        if (chart) {
                            chart.applyNewData(result.data.map(item => ({
                                timestamp: item.timestamp,
                                open: item.open,
                                high: item.high,
                                low: item.low,
                                close: item.close,
                                volume: item.volume
                            })));
                        }
                        
                        // Âª∫Á´ãWebSocketËøûÊé•
                        connectWebSocket();
                        
                    } catch (err) {
                        console.error('Ëé∑ÂèñÊï∞ÊçÆÂ§±Ë¥•:', err);
                        error.value = 'Ëé∑ÂèñÊï∞ÊçÆÂ§±Ë¥•Ôºå‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ: ' + err.message;
                        
                        // ÂõûÈÄÄÂà∞Ê®°ÊãüÊï∞ÊçÆ
                        const data = generateMockData(selectedSymbol.value);
                        chartData.value = data;
                        currentStock.value = data[data.length - 1];
                        isConnected.value = false;
                        lastUpdate.value = new Date().toLocaleString('zh-CN');
                        
                        if (chart) {
                            chart.applyNewData(data.map(item => ({
                                timestamp: item.timestamp,
                                open: item.open,
                                high: item.high,
                                low: item.low,
                                close: item.close,
                                volume: item.volume
                            })));
                        }
                        
                        // ÂêØÂä®Ê®°ÊãüÊõ¥Êñ∞
                        startRealTimeUpdate();
                        
                    } finally {
                        loading.value = false;
                    }
                };
                
                // ËøûÊé•WebSocket
                const connectWebSocket = () => {
                    // ÂÖ≥Èó≠Áé∞ÊúâËøûÊé•
                    if (ws) {
                        ws.close();
                    }
                    
                    try {
                        ws = new WebSocket(`${WS_BASE}?symbol=${selectedSymbol.value}`);
                        
                        ws.onopen = () => {
                            console.log('WebSocketËøûÊé•Â∑≤Âª∫Á´ã');
                            isConnected.value = true;
                            error.value = '';
                        };
                        
                        ws.onmessage = (event) => {
                            const message = JSON.parse(event.data);
                            if (message.type === 'update' || message.type === 'initial') {
                                const newData = message.data;
                                
                                // Êõ¥Êñ∞ÂΩìÂâçËÇ°Á•®Êï∞ÊçÆ
                                currentStock.value = newData;
                                lastUpdate.value = new Date().toLocaleString('zh-CN');
                                
                                if (message.type === 'update') {
                                    // Ê∑ªÂä†Êñ∞Êï∞ÊçÆÂà∞ÂõæË°®
                                    chartData.value.push(newData);
                                    
                                    // ‰øùÊåÅÊúÄÂ§ö200‰∏™Êï∞ÊçÆÁÇπ
                                    if (chartData.value.length > 200) {
                                        chartData.value.shift();
                                    }
                                    
                                    // Êõ¥Êñ∞ÂõæË°®
                                    if (chart) {
                                        chart.updateData(newData);
                                    }
                                }
                            }
                        };
                        
                        ws.onerror = (error) => {
                            console.error('WebSocketÈîôËØØ:', error);
                            isConnected.value = false;
                            error.value = 'WebSocketËøûÊé•ÈîôËØØÔºå‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ';
                            
                            // ÂõûÈÄÄÂà∞Ê®°ÊãüÊõ¥Êñ∞
                            startRealTimeUpdate();
                        };
                        
                        ws.onclose = () => {
                            console.log('WebSocketËøûÊé•Â∑≤ÂÖ≥Èó≠');
                            isConnected.value = false;
                            
                            // Â∞ùËØïÈáçËøû
                            setTimeout(() => {
                                if (selectedSymbol.value) {
                                    connectWebSocket();
                                }
                            }, 5000);
                        };
                        
                    } catch (err) {
                        console.error('WebSocketËøûÊé•Â§±Ë¥•:', err);
                        isConnected.value = false;
                        error.value = 'WebSocketËøûÊé•Â§±Ë¥•Ôºå‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ';
                        startRealTimeUpdate();
                    }
                };
                
                // Êõ¥Êñ∞ÂÆûÊó∂Êï∞ÊçÆ
                const updateRealTimeData = () => {
                    if (chartData.value.length === 0) return;
                    
                    const lastData = chartData.value[chartData.value.length - 1];
                    const now = new Date();
                    
                    // ÁîüÊàêÊñ∞ÁöÑÊï∞ÊçÆÁÇπ
                    const change = (Math.random() - 0.5) * lastData.close * 0.01;
                    const newPrice = Math.max(lastData.close + change, lastData.close * 0.99);
                    
                    const newData = {
                        timestamp: now.getTime(),
                        open: lastData.close,
                        high: Math.max(lastData.close, newPrice),
                        low: Math.min(lastData.close, newPrice),
                        close: parseFloat(newPrice.toFixed(2)),
                        volume: Math.floor(Math.random() * 500000) + 50000
                    };
                    
                    // Êõ¥Êñ∞Êï∞ÊçÆ
                    chartData.value.push(newData);
                    currentStock.value = newData;
                    lastUpdate.value = new Date().toLocaleString('zh-CN');
                    
                    // ‰øùÊåÅÊúÄÂ§ö200‰∏™Êï∞ÊçÆÁÇπ
                    if (chartData.value.length > 200) {
                        chartData.value.shift();
                    }
                    
                    // Êõ¥Êñ∞ÂõæË°®
                    if (chart) {
                        chart.updateData(newData);
                    }
                };
                
                // ÂàáÊç¢ËÇ°Á•®
                const changeSymbol = () => {
                    // ÂÅúÊ≠¢ÂΩìÂâçÁöÑÊ®°ÊãüÊõ¥Êñ∞
                    stopRealTimeUpdate();
                    
                    // ÈÄöÁü•WebSocketÂàáÊç¢ËÇ°Á•®
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({ symbol: selectedSymbol.value }));
                    }
                    
                    // ÈáçÊñ∞Ëé∑ÂèñÊï∞ÊçÆ
                    fetchStockData();
                };
                
                // Ê†ºÂºèÂåñ‰∫§ÊòìÈáè
                const formatVolume = (volume) => {
                    if (volume >= 1000000) {
                        return (volume / 1000000).toFixed(1) + 'M';
                    } else if (volume >= 1000) {
                        return (volume / 1000).toFixed(1) + 'K';
                    }
                    return volume.toString();
                };
                
                // ÂêØÂä®ÂÆöÊó∂Êõ¥Êñ∞
                const startRealTimeUpdate = () => {
                    if (updateInterval) {
                        clearInterval(updateInterval);
                    }
                    updateInterval = setInterval(updateRealTimeData, 10000); // ÊØè10ÁßíÊõ¥Êñ∞
                };
                
                // ÂÅúÊ≠¢ÂÆöÊó∂Êõ¥Êñ∞
                const stopRealTimeUpdate = () => {
                    if (updateInterval) {
                        clearInterval(updateInterval);
                        updateInterval = null;
                    }
                };
                
                // ÁªÑ‰ª∂ÊåÇËΩΩ
                onMounted(() => {
                    initChart();
                    fetchStockData();
                    startRealTimeUpdate();
                });
                
                // ÁªÑ‰ª∂Âç∏ËΩΩ
                onUnmounted(() => {
                    stopRealTimeUpdate();
                    if (ws) {
                        ws.close();
                    }
                    if (chart) {
                        chart.destroy();
                    }
                });
                
                return {
                    selectedSymbol,
                    chartData,
                    currentStock,
                    loading,
                    error,
                    isConnected,
                    lastUpdate,
                    priceChange,
                    changeSymbol,
                    formatVolume
                };
            }
        }).mount('#app');
    </script>
</body>
</html>